id: com.dingtalk.DingTalk
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: dingtalk
separate-locales: false

finish-args:
  - --share=ipc
  - --share=network
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  # System tray icon
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --own-name=org.kde.*
  # Screenshot
  - --talk-name=org.gnome.Shell.Screenshot
  - --talk-name=org.kde.kwin.Screenshot
  # Files
  - --filesystem=xdg-download
  - --filesystem=xdg-music
  - --filesystem=xdg-pictures
  - --persist=.ut_storage
  # Font config
  - --filesystem=xdg-config/fontconfig:ro
  # Hidpi scale
  - --env=QT_AUTO_SCREEN_SCALE_FACTOR=1

modules:
  - name: fontconfig
    buildsystem: simple
    build-commands:
      - install -Dm644 local.conf -t $FLATPAK_DEST/etc/fonts/
      - install -Dm644 70-noto-cjk.conf -t $FLATPAK_DEST/etc/fonts/conf.d/
      - install -Dm644 75-noto-color-emoji.conf -t $FLATPAK_DEST/etc/fonts/conf.d/
    sources:
      - type: file
        path: fontconfig/local.conf
      - type: file
        path: fontconfig/75-noto-color-emoji.conf
      - type: file
        url: https://gitlab.archlinux.org/archlinux/packaging/packages/noto-fonts-cjk/-/raw/5fd3534bf7a6e26c7506dc8f40dcd89f37d35627/70-noto-cjk.conf
        sha256: 2417ac0e6720fe8da55ee59f16e36cfe96737bc21432460a322bb0f395e3a521

  - name: libxcrypt
    config-opts:
      - --prefix=/app
      - --enable-shared
      - --enable-obsolute-api=glibc
    sources:
      - type: archive
        url: https://github.com/besser82/libxcrypt/releases/download/v4.4.36/libxcrypt-4.4.36.tar.xz
        sha256: e5e1f4caee0a01de2aee26e3138807d6d3ca2b8e67287966d1fefd65e1fd8943
        x-checker-data:
          type: anitya
          project-id: 16436
          url-template: https://github.com/besser82/libxcrypt/releases/download/v$version/libxcrypt-$version.tar.xz

  - name: dingtalk
    buildsystem: simple
    build-commands:
      - install -Dm644 com.dingtalk.DingTalk.metainfo.xml -t $FLATPAK_DEST/share/metainfo
      - install -Dm644 com.dingtalk.DingTalk.png -t $FLATPAK_DEST/share/icons/hicolor/256x256/apps
      - install -Dm644 com.dingtalk.DingTalk.desktop -t $FLATPAK_DEST/share/applications
      - install -Dm755 apply_extra.sh $FLATPAK_DEST/bin/apply_extra
      - install -Dm755 dingtalk.sh $FLATPAK_DEST/bin/dingtalk
    sources:
      - type: script
        dest-filename: apply_extra.sh
        commands:
          - bsdtar --to-stdout -xf dingtalk.deb data.* | bsdtar -xf -

          - mv opt/apps/com.alibabainc.dingtalk/files/*Release* -T dingtalk
          - mv opt/apps/com.alibabainc.dingtalk/files/version -T version

          - rm dingtalk/libm.so.6 dingtalk/libstdc++.so.6 dingtalk/libstdc++.so.6.0.25
          - rm -r opt usr dingtalk.deb
      - type: file
        path: dingtalk.sh
      - type: file
        path: com.dingtalk.DingTalk.metainfo.xml
      - type: file
        path: com.dingtalk.DingTalk.png
      - type: file
        path: com.dingtalk.DingTalk.desktop
      - type: extra-data
        url: https://pro-store-packages.uniontech.com/appstore/pool/appstore/c/com.alibabainc.dingtalk/com.alibabainc.dingtalk_7.5.10.404071_amd64.deb
        sha256: a0d21d2d04100cc8d4ff60ed8ecb09aee1692651aa508694632a5df63d73c9d4
        size: 340219654
        filename: dingtalk.deb
        only-arches: [x86_64]
        x-checker-data:
          type: debian-repo
          package-name: com.alibabainc.dingtalk
          root: https://pro-store-packages.uniontech.com/appstore
          dist: eagle-pro
          component: appstore
          is-main-source: true
      - type: extra-data
        url: https://pro-store-packages.uniontech.com/appstore/pool/appstore/c/com.alibabainc.dingtalk/com.alibabainc.dingtalk_7.5.10.404071_arm64.deb
        sha256: 0b6000bb9a0d400517fdcd06c775dae50f347ef5a49d2c509a5540bd6b1ed27f
        size: 320842750
        filename: dingtalk.deb
        only-arches: [aarch64]
        x-checker-data:
          type: debian-repo
          package-name: com.alibabainc.dingtalk
          root: https://pro-store-packages.uniontech.com/appstore
          dist: eagle-pro
          component: appstore
          is-main-source: true
